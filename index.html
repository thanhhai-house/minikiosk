document.addEventListener("DOMContentLoaded", () => {

const KEY = "KIOSK_FIX_V1";
let items = JSON.parse(localStorage.getItem(KEY) || "[]");

const $ = id => document.getElementById(id);

const form = $("form");
const list = $("list");
const preview = $("preview");
const previewText = $("previewText");

let currentImage = null;

/* ===== IMAGE PREVIEW (FIX CHẮC CHẮN) ===== */
$("image").addEventListener("change", e => {
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    currentImage = reader.result;
    preview.src = currentImage;
    preview.style.display = "block";
    previewText.style.display = "none";
  };
  reader.readAsDataURL(file);
});

/* ===== CLEAR FORM ===== */
function clearForm(){
  form.reset();
  currentImage = null;
  preview.src = "";
  preview.style.display = "none";
  previewText.style.display = "block";
}

/* ===== SAVE ===== */
form.addEventListener("submit", e => {
  e.preventDefault();

  const item = {
    id: Date.now(),
    oem: $("oem").value,
    name: $("name").value,
    brand: $("brand").value,
    type: $("type").value,
    price: Number($("price").value),
    qty: Number($("qty").value),
    note: $("note").value,
    image: currentImage
  };

  items.push(item);
  localStorage.setItem(KEY, JSON.stringify(items));

  clearForm();
  render();
});

/* ===== RENDER LIST (FIX CHẮC CHẮN) ===== */
function render(){
  if(items.length === 0){
    list.innerHTML = "<i>Chưa có sản phẩm</i>";
    return;
  }

  list.innerHTML = items.map(it => `
    <div class="card">
      ${it.image ? `<img src="${it.image}">` : `<img src="" alt="">`}
      <div class="body">
        <b>${it.name}</b><br>
        OEM: ${it.oem}<br>
        <span class="tag">${it.brand}</span>
        <span class="tag">${it.type}</span><br>
        Tồn: <b>${it.qty}</b><br>
        Giá: <b>${it.price.toLocaleString()}₫</b>
        <div style="font-size:12px;color:#475569;margin-top:4px">${it.note||""}</div>
      </div>
    </div>
  `).join("");
}

$("btnClear").addEventListener("click", clearForm);

/* ===== INIT ===== */
render();

});
